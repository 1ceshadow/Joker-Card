# 一款局域网内 打牌游戏
游戏灵感：炸金花 + Balatro小丑牌

## 游戏流程
最开始玩家进入游戏程序时，读取玩家信息文件，如果文件为空，弹出一个窗口，让玩家输入名称，在头像库里选择一个头像。  

1、房主创建一个房间，  
2、点击一个按钮邀请别人(参见局域网联机部分)  
3、当玩家数 > 2时 可以点击打开游戏按钮。最多5人  
## 一场游戏内循环：

### 游戏开始：
所有人投入押金 押金数 = 开始底金，所有的押金计入到 底池内 

给玩家随机排序，确定为 出牌顺序  
牌组随机洗牌，确定牌组内牌的顺序；  
按照出牌顺序，给每个人发n张牌( n = 手牌数量 )   
给玩家自己显示自己的手牌，玩家与玩家之间手牌互不可见  
### 内循环：

按照出牌顺序，依次进入他们的回合，  

对于一个玩家的一个回合：  
如果该玩家的 剩余出牌次数 == 0，跳过该玩家  
玩家有三个按钮，**出牌、押注、弃牌**  
出牌和弃牌按钮，得玩家选择指定的牌，这俩个按钮才会亮起，才可以按  
而且弃牌按钮，得玩家的 剩余弃牌数量 > 0才会亮起，才可以按  
押注按钮，只有当场上玩家数 >= 2时，才能用  

当选择**押注**时，弹出一个窗口，  
窗口内一个输入框要玩家输出押注的金额，一个押注按钮。这样押注按钮，得输入金额符合规则，才能按下，进行押注操作。(规则就是，押注金额得小于玩家的资金数)；玩家资金扣除 押注数额。押注金额计入 底池  

当选择**出牌**时：  
出牌可出 大于0 小于等于 最多出牌数量的 牌  
对所有玩家显示 该玩家选择出的牌，对该牌进行计算，计算得分，显示该玩家得分  
该玩家剩余出牌次数 - 1，该玩家所有的牌(包括出的牌 和 没出的手牌)随机插入到牌组内。  
最终只比“出牌那1次”的分数，没出牌的分数不算。插回是为别人弃牌抽新牌用。

当选择**弃牌**时:  
玩家选择不想要的牌，进行舍弃，再从牌组中抽取等数量的牌。弃掉的这些牌在随机插入到牌组中  
（弃牌后立即摸牌）  

当选择押注完或出牌完，结束玩家该回合，轮到下一个玩家回合。

也就是说，一场游戏内，一个玩家只能出一次牌；  
每次轮到玩家的回合必须选择出牌还是押注(如果场上只剩该玩家，则必须出牌)；  
但弃牌可以一个回合多次弃牌。也可以分多个回合弃牌，只要该玩家还有出牌次数和弃牌次数  


### 结束
一场游戏获胜规则:   
  所有玩家出完牌后，比较各自分数，得分最高的玩家获胜 所有押金归入该玩家账户。  
(分数相同则平分，除不尽的情况，余数归庄家(系统))  
一场游戏结束后，回到主菜单界面  
# 参数
开始底金 = 5  
手牌数量 = 8  
最多出牌牌数 = 5  
最多弃牌牌数 = 4  
剩余出牌次数 = 1  
剩余弃牌次数 = 3  
最多小丑牌数 = 5  
商店显示小丑牌的个数 = 10  

牌组：就普通的扑克牌去掉大小王，52张  

# 分数计算
类似于小丑牌。  
像Balatro的chips × multiplier  
出任意1-5张，自动评判扑克牌型（见下表），chips×mult。单张=High Card。  

牌型 (1-5张) | 示例 | 基chips | 基mult | 示例分数 (无joker)  
--- | --- |    --- |  ---    | ---    |
High Card (单张/散牌) | A | 5 | 1 | (14牌值+5)×1=19  
Pair (对子) | AA|10|2 | 38×2=76
Two Pair| AAKK|20 | 2 | 58×2=116  
Three of a Kind (三条)|AAA|30|3|52×3=156  
Straight (顺子)|A5432|30|4|62×4=248  
Flush (同花)| 黑桃5张| 35|4|67×4=268  
Full House (葫芦)|AAAKK|40|4|78×4=312  
Four of a Kind (四条)|AAAAx|60|7|94×7=658  
Straight Flush (顺金)|黑桃顺子|100|8|112×8=896  

步骤：  
1. 出牌1-5张 → 自动检测最佳扑克牌型（高优先覆盖低）。  
2. 基础chips = 牌型chips + 单张牌面值chips（A=14, 2=2...10=10, J=11,Q=12,K=13）。  
3. 基础mult = 牌型mult。  
4. 总chips = 基础chips + 小丑牌chips加成。  
5. 总mult = 基础mult + 小丑牌mult加成。  
6. 最终分数 = 总chips × 总mult（四舍五入到整数）。  


# 小丑牌 和 商店  
玩家出完牌后，计算分数时，小丑牌给予分数加成。  

商店买的小丑牌是是永久拥有的，玩家最多有5张小丑牌，购买的小丑牌，可以再卖掉，为售卖价。  
之后有很多  
现在只列几个  
稀有度 |名称 |效果（出牌时触发）|商店价 |售卖价
--- | --- | ---| ---| --- |  
普通| Joker | +4 Mult |3| 3    
普通 |Greedy Joker |每张方片 +3 Mult |4| 3    
普通 |Lusty Joker| 每张红桃 +3 Mult |4| 3    
普通 |Wrathful Joker| 每张黑桃 +3 Mult |4| 3   
普通 |Gluttonous Joker| 每张梅花 +3 Mult |4| 3   
普通 |Jolly Joker |有对子 +8 Mult |6| 4  
--- | 。。。


商店：  
玩家最开始创建账号时，随机上架10张小丑牌    
每局游戏结束后，重新刷新小丑牌。  
当小丑牌卡位有空位时，玩家可购买小丑牌，    
购买小丑牌，商店不再补货，直到下一次刷新。  



# 保存信息系统
保存玩家的 名称，ip，头像id，资金数，欠钱数，小丑牌组合。商店内的小丑牌  

# 资金
每个人起始资金为20  
每一场游戏 如果盈利，则增加资金，反之扣资金  

资金不足押注时允许欠（负资金）向系统借钱，但一场游戏结束后，赢钱优先还欠  

# 联机系统
要跨平台 安卓、IOS（Windows/Linux？）  
联机方式：局域网联机  
  
显示ip,输入快速连接  
可以通过输入房主ip  
或者直接扫描当前局域网下可以邀请的玩家，显示出来  
房主就作为服务端。  

可选：显示房主二维码，扫房主的二维码  

# 项目结构
```bash
Assets/  
├── Scripts/  
│   ├── Cards/ (牌数据)  
│   ├── Network/ (Mirror)  
│   ├── Game/ (逻辑)  
|   ├── Uits (生成扑克牌、小丑牌等)  
│   └── UI/  
├── Prefabs/  
│   ├── Card.prefab  
│   └── Player.prefab  
├── Scenes/  
│   ├── MainMenu.unity  
│   ├── CreateRoom.unity  
│   ├── JoinRoom.unity  
│   └── GameRoom.unity  
```


# 游戏UI
玩家进入游戏时的UI类似于Balatro小丑牌  
主菜单界面：  
左侧：上面显示玩家头像、名称、资金 / 负债 下面：会有三个个按钮，创建房间，加入房间，退出游戏  
右侧中下部是商店，可以买小丑牌。右侧上部显示玩家当前的小丑牌组合  

组队界面：  
点击创建房间后，左侧显示房主的ip，(二维码)，右侧显示在该房间的玩家的头像(包括房主本人)，右侧下面显示两个按钮：开始游戏，离开房间

局内界面：  
左上角显示玩家头像、名称、资金 / 负债  
中间偏右 最上边一栏显示自己持有的小丑牌  
最下面一栏显示自己的手牌，手牌上面显示3个按钮，出牌、押注、弃牌  
然后屏幕四周部分：根据玩家数量，按出牌顺序，逆时针均衡显示玩家头像，  
最中间显示玩家出的牌。  
右下角是一个牌组的示例  
当A玩家出一组牌时先在最中间显示他出的牌，当轮到下一个人B的回合时，把A的牌在他的头像旁边显示，并显示他的分数  
上回合A出的牌，依旧显示，直到有一个人出牌，则显示下一个人出牌的牌。  

玩家点击牌特效  
点击小丑牌：该小丑牌右侧显示 售卖的按钮，再次点击小丑牌，恢复正常  
游戏中，点击手牌，则将该手牌从一组手牌中向上移动一些，表示待选状态。再次点击该手牌，恢复原样，表示，不再选择该手牌，当玩家以及选了5张手牌(最多出牌牌数)，则不能在选择其他牌  

## 素材
总共四张大图片
我现在获得的素材是每个小丑牌是71x95,
扑克牌背面是70.6x93,扑克牌是正面是71x95。头像355x420

## 待确认项与建议性澄清（Open Questions & Proposed Clarifications）

下面列出在实现时容易引起混淆或需要明确的规则，并给出建议性的默认值/实现策略。请确认或提出修改，我会据此同步到项目文档并更新实现。

1) 押注（Betting）规则
  - 开发问题：文档中只写了“押注金额得小于玩家的资金数”，但代码中允许欠款。需明确是否允许透支（欠款），以及最大欠款限额。>>> 明确：只允许在一局游戏外进行欠债。更改需求，在主菜单增加一个借钱按钮，并记录玩家的借钱数据。在游戏内，不允许再欠钱。
  - 建议（可调整）：允许玩家透支，但最大欠款限制为“起始资金”的两倍（默认 20 → 最多欠 -40）。投注输入必须为正整数且不超过 `player.currentMoney + overdraftLimit`。>>> 增加最大欠钱限制为10倍
  - 提示（实现）：在 `ShopManager`/`PlayerData` 中对下注请求做服务器端校验，拒绝非法数值并返回错误信息给客户端。 >>> 增加

2) 弃牌与出牌的时机/次数
  - 开发问题：当前规则写“弃牌可以在一个回合多次，也可以跨回合进行”，但未明确每次弃牌是否消耗额外资源或回合内的时间限制。>>> 只要进行一次弃牌，就消耗一次次数。
  - 建议（可调整）：弃牌只能在玩家回合内进行（可多次），每次弃牌按弃牌张数立即补牌，不消耗额外的“出牌次数”；弃牌总次数受玩家的 `剩余弃牌次数` 限制（默认 3）。 >>> 对。每次弃牌按弃牌张数立即补牌。和出牌次数没有关系。可以在自己的一个回合内，消耗完所有弃牌次数。

3) 出牌次数与回合结束条件
  - 开发问题：文档已写“一个玩家只能出一次牌”，但没有明确回合内是否可弃牌后再次出牌。
  - 建议（可调整）：在玩家回合内，玩家可以先弃牌（受弃牌次数限制），但只能在整个局内最多出一次牌；一旦本局出过牌（出牌次数耗尽），未来回合跳过出牌选项。 >>> 在玩家回合内，玩家可以先弃牌（受弃牌次数限制），但只能在整个局内最多出一次牌；一旦本局出过牌（出牌次数耗尽），未来回合跳过该玩家，该玩家进入观战状态。

4) 小丑牌触发顺序与叠加规则
  - 开发问题：小丑牌的触发条件和叠加顺序未完全明确（例如同时存在多张加mult的牌时，先计算 chips 还是 multiplier？）
  - 建议（实现顺序）：
    - 先计算基础 chips（牌型 chips + 单张牌面值）
    - 将所有小丑牌的 chips 加成叠加到基础 chips
    - 再计算基础 multiplier（牌型 mult）
    - 将所有小丑牌的 mult 加成叠加到 multiplier
    - 最终分数 = round( totalChips × totalMultiplier )
  - 若需特殊交互（例如某张 Joker 在特定条件触发），应在 `JokerData` 中以显式触发条件列出并在 Scoring 中优先处理。 >>> 玩家总共可以有5张小丑牌，！ 增加功能，玩家可以手动调整小丑牌的顺序(无论在游戏中，还是主菜单界面)，(在游戏中也可以调整手牌的顺序)。核算时，小丑牌，从左往右，依次检测是否触发。

5) 商店刷新策略
  - 开发问题：文档写“每局游戏结束后重新刷新小丑牌”，需明确刷新时机及是否为全局（服务器端）刷新或每个客户端本地刷新。
  - 建议（默认实现）：商店由服务器统一维护并在每局结束时刷新（全局）。玩家购买更新服务器状态，不在本局补货，下一次刷新由服务器生成新的 10 张小丑牌并广播。
  - >>> 因为我们的是局域网游戏，当退出房间时，就没有服务器了，就完全本地。所以每次结束游戏后，回到主菜单时，就随机刷新。

6) 存档格式与持久化
  - 开发问题：未明确保存文件格式与字段名（JSON/二进制），以及是否包含商店状态。
  - 建议：使用 JSON 存储 `PlayerSaveData`（字段：playerName, avatarId, money, debt, jokersList）在 `Application.persistentDataPath/players/<playerId>.json`。商店状态由服务器维护（不保存在本地玩家存档中）。>>> 用JSON储存，局域网游戏，没有服务器

7) 联机/服务器权威（Networking）
  - 开发问题：需要明确哪些逻辑在服务器端校验（例如下注、购买、牌面验证等）。
  - 建议（安全）：服务器为权威方，验证所有关键操作（下注金额、购买请求、出牌合法性）。客户端仅为展示与输入。RPC/Command 必须在服务器端再次校验参数。

8) 场景与流程名称
  - 已知变更：你将 `GameRoom` 拆分为 `CreateRoom`（房主/客户端同步用）与 `JoinRoom`（客户端输入 IP）。请在所有文档中统一场景名称（我已在 `NETWORK_SETUP.md` / `SETUP_GUIDE.md` / `QUICK_REFERENCE.md` 做同步说明）。

===

已在其它文档中应用的当前默认值（待你确认）：
- 起始资金：20（已存在）
- 允许透支（欠款）：默认上限 = 起始资金 × 2（默认 -40）——可修改为无限或 0（禁止透支）
- 商店刷新：每局结束时由服务器统一刷新，全局生效
- 小丑牌触发顺序：chips 累加后 mult 累加（参见上文）

请阅读以上“待确认项”，标注你想保持/修改的项，我会把这些决定合并到代码注释与项目文档中。