# 确认规则合并总结

## 时间
2025年11月25日

## 概述
根据您在 `GDD.md` 中的 >>> 标注，已将所有模糊的游戏规则转换为明确的实现指南，并更新到项目文档中。

## 更新的文件

### 1. 文档/GDD.md
**更改内容**：将"待确认项与建议性澄清"部分替换为"已确认规则澄清"，整理为8个小节

**关键确认**：
- ✅ 押注与欠债：允许 10 倍初始资金的欠款，仅在主菜单可借钱，游戏中禁止透支
- ✅ 弃牌规则：每次弃牌消耗 1 次弃牌次数，与出牌次数无关，可在一回合内多次弃牌
- ✅ 出牌与观战：一局只能出一次牌，出过后在后续回合直接跳过进入观战
- ✅ 小丑牌顺序：玩家可手动调整，从左到右依次触发，先累加 chips 再累加 mult
- ✅ 商店刷新：每局结束返回主菜单时本地随机刷新（10 张牌）
- ✅ 存档格式：JSON 格式，新增 `borrowedAmount` 字段
- ✅ 联机权威：房主为服务端验证所有关键操作
- ✅ UI 功能：主菜单新增"借钱"按钮

### 2. 文档/SETUP_GUIDE.md
**新增部分**："已确认的游戏规则（重要）"小节

**包含内容**：
- 1.1 押注与欠债（欠债限制、时机、服务器校验、赢钱清债）
- 2.1 弃牌规则（次数消耗、立即补牌、多次弃牌）
- 3.1 出牌与观战（一局一次、观战模式、手牌处理）
- 4.1 小丑牌触发顺序（手动排序、从左到右、计算顺序）
- 5.1 商店与持久化（本地刷新、不补货、JSON 存储）

### 3. 文档/QUICK_REFERENCE.md
**新增部分**："已确认的核心规则"小节

**快速参考表**：
- 押注与欠债：10 倍上限、主菜单借钱、赢钱清债、服务器校验
- 出牌后观战：一局一次、弃牌独立、手牌随机插回
- 小丑牌触发：手动排序、从左到右、计算公式
- 商店与保存：本地刷新、不补货、JSON 字段

## 后续实现建议

### 代码注释更新（待完成）
建议在以下文件中添加详细注释，引用这些确认规则：

1. **PlayerData.cs**
   ```csharp
   // [SyncVar] public int debt; // 欠债数额，最大不超过 initMoney * 10
   // [SyncVar] public int borrowedAmount; // 在主菜单借入的总金额
   // 赢钱时优先清偿欠债：remainder = winMoney - debt; debt = Math.Max(debt - winMoney, 0);
   ```

2. **Scoring.cs**
   ```csharp
   // 小丑牌触发顺序：从左到右（按 jokersList 顺序）
   // 1. 计算基础 chips（牌型 + 单张牌面值）
   // 2. 依次触发小丑牌，累加 chips 加成
   // 3. 计算基础 mult（牌型）
   // 4. 依次触发小丑牌，累加 mult 加成
   // 5. 最终分数 = round(totalChips * totalMult)
   ```

3. **GameManager.cs**
   ```csharp
   // 出牌规则：每个玩家整局只能出一次牌（playedCards = 1）
   // 一旦 playedCards 耗尽，后续回合直接跳过该玩家（进入观战状态）
   
   // 弃牌规则：每次弃牌消耗 1 次弃牌次数，与出牌次数无关
   // 可在一个回合内多次弃牌，只要 discardCount > 0
   ```

4. **ShopManager.cs**
   ```csharp
   // 商店刷新时机：游戏结束返回主菜单时刷新
   // 刷新方式：本地随机生成 10 张小丑牌
   // 当局规则：购买后不补货，直到下一次刷新
   ```

### UI 功能新增（待完成）
- 在 `MainMenu.cs` 左下角添加"借钱"按钮
- 弹出输入框，显示当前欠债和借钱上限
- 限制最大借入金额为 `10 * initialMoney - currentDebt`

### 特性实现建议（待完成）
1. 玩家小丑牌排序 UI（拖拽/上下按钮调整顺序）
2. 玩家手牌排序 UI（游戏中支持调整）
3. 观战模式 UI（明确显示"该玩家已出牌，进入观战"状态）
4. 欠债清偿动画（赢钱时显示"清偿欠债"过程）

## 验证清单
- [x] GDD.md 已更新为确认规则
- [x] SETUP_GUIDE.md 已添加规则详解
- [x] QUICK_REFERENCE.md 已添加快速参考
- [ ] PlayerData.cs 注释已更新
- [ ] Scoring.cs 注释已更新
- [ ] GameManager.cs 注释已更新
- [ ] ShopManager.cs 注释已更新
- [ ] MainMenu.cs 添加"借钱"按钮
- [ ] 游戏中实现小丑牌手动排序功能
- [ ] 游戏中实现手牌手动排序功能
- [ ] 测试出牌后观战逻辑

## 下一步行动
1. 在各代码文件中添加详细注释（参考上面的建议模板）
2. 实现主菜单"借钱"功能
3. 实现小丑牌/手牌排序 UI 功能
4. 在 GameManager 中实现"出牌后跳过"逻辑
5. 对规则进行集成测试验证
